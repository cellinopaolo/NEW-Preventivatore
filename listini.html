<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genesis - Gestione Database</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #2980b9; --bg: #f4f7f6; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        
        /* Selettore Tabella */
        .selector-box { background: #ebf2f7; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; }
        select { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; flex-grow: 1; }

        .table-container { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; text-transform: uppercase; font-size: 0.75rem; white-space: nowrap; }
        td { border-bottom: 1px solid #eee; padding: 8px; }
        input { width: 100%; padding: 8px; border: 1px solid transparent; border-radius: 4px; box-sizing: border-box; }
        input:focus { border-color: var(--accent); background: #fff; outline: none; }
        
        .actions { display: flex; justify-content: space-between; margin-top: 20px; gap: 10px; }
        .btn { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; color: white; }
        .btn-add { background: var(--success); }
        .btn-save { background: var(--accent); flex-grow: 1; }
        .btn-del { background: var(--danger); padding: 5px 10px; font-size: 0.7rem; }
        #status { font-size: 0.9rem; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="margin:0">‚öôÔ∏è Gestione Database Genesis</h2>
        <a href="index.html" style="text-decoration:none; color:var(--primary); font-weight:bold;">Torna alla Home</a>
    </div>

    <div class="selector-box">
        <strong>Scegli cosa gestire:</strong>
        <select id="table-selector" onchange="fetchData()">
            <optgroup label="MATTONI">
                <option value="mattoni_genesis">Genesis</option>
                <option value="mattoni_futura">Futura</option>
                <option value="mattoni_croma">Croma</option>
                <option value="mattoni_fortis">Fortis</option>
                <option value="mattoni_cotto">Cotto</option>
            </optgroup>
            <optgroup label="PIETRE">
                <option value="pietre_posa_incerta">Posa incerta</option>
                <option value="pietre_pannelli">Pannelli preassemblati</option>
                <option value="pietre_rettangolare">Taglio Rettangolare</option>
                <option value="pietre_pavimentazione">Pavimentazione pietra</option>
                <option value="pietre_tetti">Tetti</option>
            </optgroup>
            <optgroup label="LEGNO">
                <option value="legno_rivestimenti">Rivestimenti</option>
                <option value="legno_pavimenti">Pavimenti legno</option>
            </optgroup>
        </select>
    </div>

    <div class="table-container">
        <table id="data-table">
            <thead id="table-head"></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <div id="status"></div>

    <div class="actions">
        <button class="btn btn-add" onclick="addRow()">+ Aggiungi Riga</button>
        <button class="btn btn-save" onclick="syncData()">üíæ SALVA E SINCRONIZZA TUTTI I DISPOSITIVI</button>
    </div>
</div>

<script>
    const _supabase = window.supabase.createClient('https://dzdbctihpqrgjfhiisxh.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6ZGJjdGlocHFyZ2pmaGlpc3hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxODkyNzEsImV4cCI6MjA4Nzc2NTI3MX0.XWhI_mRPXzm36Lq0PFJ2lRm6sFjMfOFWNY4AlXDpqfQ');
    
    let currentData = [];
    let tableSchema = [];

    // Definiamo le colonne per ogni tabella (escludendo id e macrocategoria che gestiamo noi)
    const columnsMap = {
        mattoni_genesis: ['nome', 'prezzo_pz', 'pz_m2', 'pz_scatola', 'pz_bancale', 'kg_bancale', 'sfuso'],
        mattoni_futura: ['nome', 'prezzo_pz', 'pz_m2', 'pz_bancale', 'kg_bancale', 'sfuso'],
        mattoni_croma: ['nome', 'prezzo_pz', 'pz_m2', 'pz_bancale', 'kg_bancale', 'sfuso'],
        mattoni_fortis: ['nome', 'prezzo_pz', 'pz_m2_coltello', 'pz_m2_piatto', 'pz_bancale', 'kg_bancale', 'sfuso'],
        mattoni_cotto: ['nome', 'prezzo_pz', 'pz_m2', 'pz_bancale', 'kg_bancale', 'sfuso'],
        pietre_posa_incerta: ['nome', 'prezzo_unita', 'pz_ml', 'm2_bancale', 'pz_bancale', 'kg_bancale', 'sfuso'],
        pietre_pannelli: ['nome', 'prezzo_m2', 'm2_scatola', 'm2_bancale', 'kg_bancale', 'sfuso'],
        pietre_rettangolare: ['nome', 'prezzo_m2', 'm2_bancale', 'kg_bancale', 'sfuso'],
        pietre_pavimentazione: ['nome', 'prezzo_m2', 'm2_bancale', 'kg_bancale', 'sfuso'],
        pietre_tetti: ['nome', 'prezzo_pz', 'pz_m2', 'pz_bancale', 'kg_bancale', 'sfuso'],
        legno_rivestimenti: ['nome', 'prezzo_m2', 'sfuso'],
        legno_pavimenti: ['nome', 'prezzo_m2', 'sfuso']
    };

    async function fetchData() {
        const tableName = document.getElementById('table-selector').value;
        updateStatus("Caricamento in corso...", "#2980b9");
        
        const { data, error } = await _supabase.from(tableName).select('*').order('id');
        
        if (error) {
            updateStatus("Errore: Tabella non trovata nel database!", "red");
            return;
        }

        currentData = data;
        tableSchema = columnsMap[tableName];
        renderTable();
        updateStatus("Dati caricati correttamente.", "green");
    }

    function renderTable() {
        const head = document.getElementById('table-head');
        const body = document.getElementById('table-body');
        
        // Genera Intestazione
        head.innerHTML = `<tr>${tableSchema.map(col => `<th>${col.replace('_', ' ')}</th>`).join('')}<th>Azioni</th></tr>`;
        
        // Genera Righe
        body.innerHTML = '';
        currentData.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            tableSchema.forEach(col => {
                const td = document.createElement('td');
                const input = document.createElement('input');
                input.value = row[col] || '';
                input.oninput = (e) => currentData[rowIndex][col] = e.target.value;
                td.appendChild(input);
                tr.appendChild(td);
            });
            
            // Bottone Elimina
            const actionTd = document.createElement('td');
            actionTd.innerHTML = `<button class="btn btn-del" onclick="deleteRow(${row.id}, ${rowIndex})">ELIMINA</button>`;
            tr.appendChild(actionTd);
            body.appendChild(tr);
        });
    }

    function addRow() {
        const tableName = document.getElementById('table-selector').value;
        const newRow = {};
        tableSchema.forEach(col => newRow[col] = (col === 'sfuso' ? 'no' : ''));
        currentData.push(newRow);
        renderTable();
    }

    async function syncData() {
        const tableName = document.getElementById('table-selector').value;
        updateStatus("Sincronizzazione...", "orange");

        // Pulizia dati (rimozione id nulli per nuovi inserimenti)
        const cleanData = currentData.map(item => {
            const { id, ...rest } = item;
            return item.id ? item : rest;
        });

        const { error } = await _supabase.from(tableName).upsert(cleanData);

        if (error) {
            updateStatus("Errore durante il salvataggio: " + error.message, "red");
        } else {
            updateStatus("DATABASE AGGIORNATO CON SUCCESSO!", "#27ae60");
            fetchData(); // Ricarica per avere gli ID aggiornati
        }
    }

    async function deleteRow(id, index) {
        if (!id) {
            currentData.splice(index, 1);
            renderTable();
            return;
        }

        if (confirm("Sei sicuro di voler eliminare definitivamente questo prodotto?")) {
            const tableName = document.getElementById('table-selector').value;
            const { error } = await _supabase.from(tableName).delete().eq('id', id);
            if (!error) fetchData();
        }
    }

    function updateStatus(msg, color) {
        const s = document.getElementById('status');
        s.innerText = msg;
        s.style.color = color;
    }

    // Caricamento iniziale
    fetchData();
</script>
</body>
</html>
